import{r as l,J as y,j as e,B as h,C as Ee,T as c,n as Te}from"./index-TH8YGKRz.js";import{S as Ne}from"./Search-DrB_le8H.js";import{T as ke,a as Pe,b as Ve,c as X,d as m,e as Re,C as We,f as ze,P as Fe}from"./CheckBoxOutlineBlank-BWvBqfBb.js";import{M as Ue}from"./MoreVert-DIEecuZq.js";import{A as $,D as Oe,M}from"./AdminSidebar-Bc6icHTo.js";import{s as K,c as R,t as D}from"./tokens-DkKdY8jA.js";import{g as Be,a as Le,c as W,b as Ye,r as Je,d as He}from"./workspaceService-BQTsMTjt.js";import{T as _e,F as Q,a as Z,S as ee}from"./TextField-Du34Z7EL.js";import{I as Ge}from"./InputAdornment-Cgg0GFqY.js";import{A as v}from"./Alert-DkG2QiTi.js";import{B as g}from"./Button-CJZqiG46.js";import{P as qe}from"./Paper-Mdtt8qvf.js";import{C as Xe}from"./Checkbox-Ck6fmr8t.js";import{C as z}from"./Chip-DQa8OeN4.js";import{T as $e}from"./Tooltip-CHKfBYiS.js";import{I as Ke}from"./IconButton-BAp8iDOQ.js";import{D as te,a as se,b as re,c as ae}from"./DialogTitle-CKHsR478.js";import"./createSvgIcon-B0Pm_6cI.js";import"./createSvgIcon-1GfyKPJS.js";import"./useControlled-BLQOo7Av.js";import"./Menu-CzX3FVwN.js";import"./resolveComponentProps-CAz9EWAT.js";import"./Divider-7QTrz6EV.js";import"./getThemeProps-DA88l0eV.js";import"./Avatar-BgeWc8dC.js";import"./useSlot-B20WKvL2.js";import"./SwitchBase-GCTxqK2a.js";const Mt=()=>{const[S,ie]=l.useState(""),[ne,le]=l.useState([]),[I,oe]=l.useState(1),[F]=l.useState(20),[p,ce]=l.useState([]),[U,O]=l.useState(!0),[w,i]=l.useState(""),[r,A]=l.useState(null),[de,C]=l.useState(!1),[a,he]=l.useState(""),[B,me]=l.useState(0),[E,ue]=l.useState("ACTIVE"),[T,fe]=l.useState(""),[j,f]=l.useState(!1),[n,d]=l.useState(!1),[L,x]=l.useState(""),[xe,N]=l.useState(!1),[u,k]=l.useState(null),[ge,pe]=l.useState(!1),je=async()=>{try{O(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN"){i("Access denied. Admin role required.");return}}finally{d(!1)}const t=await Be();he(t.id),await b(t.id)}catch(t){i(t instanceof Error?t.message:"Failed to load workspace data")}finally{O(!1)}},b=async(t,s=1)=>{try{const o=await Le(t,{search:S||void 0,status:E||void 0,role:T||void 0,page:s,limit:F});ce(o.data),me(o.pagination.total),oe(s)}catch(o){console.error("Error fetching members:",o),i(o instanceof Error?o.message:"Failed to load members")}};l.useEffect(()=>{je();const t=setInterval(async()=>{try{d(!0),(await y()).role!=="ADMIN"&&i("You no longer have admin privileges. Please refresh the page.")}catch(s){console.warn("Role validation failed:",s)}finally{d(!1)}},5*60*1e3);return()=>clearInterval(t)},[]),l.useEffect(()=>{a&&b(a,1)},[S,E,T,a]);const be=t=>{le(s=>s.includes(t)?s.filter(o=>o!==t):[...s,t])},ye=t=>{A(t),C(!0)},Y=()=>{C(!1),A(null)},ve=async t=>{if(a)try{f(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN")throw new Error("You no longer have admin privileges. Please refresh the page.")}finally{d(!1)}await W(a,t,"ACTIVE"),x("Member activated successfully!"),await b(a,I),C(!1),A(null),setTimeout(()=>x(""),3e3)}catch(s){i(s instanceof Error?s.message:"Failed to activate member")}finally{f(!1)}},Ie=async t=>{if(a)try{f(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN")throw new Error("You no longer have admin privileges. Please refresh the page.")}finally{d(!1)}await W(a,t,"DEACTIVATED"),x("Member deactivated successfully!"),await b(a,I),C(!1),A(null),setTimeout(()=>x(""),3e3)}catch(s){const o=s instanceof Error?s.message:"Failed to deactivate member";i(o),setTimeout(()=>i(""),5e3)}finally{f(!1)}},J=async(t,s)=>{if(a)try{f(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN")throw new Error("You no longer have admin privileges. Please refresh the page.")}finally{d(!1)}await Ye(a,t,s),x("Member role updated successfully!"),await b(a,I),C(!1),A(null),setTimeout(()=>x(""),3e3)}catch(o){const Se=o instanceof Error?o.message:"Failed to change member role";i(Se),setTimeout(()=>i(""),5e3)}finally{f(!1)}},Ae=async t=>{if(a&&window.confirm("Are you sure you want to deactivate this member from the workspace?"))try{f(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN")throw new Error("You no longer have admin privileges. Please refresh the page.")}finally{d(!1)}await Je(a,t),x("Member deactivated successfully!"),await b(a,I),C(!1),A(null),setTimeout(()=>x(""),3e3)}catch(s){const o=s instanceof Error?s.message:"Failed to deactivate member";i(o),setTimeout(()=>i(""),5e3)}finally{f(!1)}},Ce=async t=>{if(a&&window.confirm("This will permanently delete the member and all related data. This action cannot be undone. Continue?"))try{f(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN")throw new Error("You no longer have admin privileges. Please refresh the page.")}finally{d(!1)}await He(a,t),x("Member permanently removed successfully!"),await b(a,I),C(!1),A(null),setTimeout(()=>x(""),3e3)}catch(s){const o=s instanceof Error?s.message:"Failed to permanently remove member";i(o),setTimeout(()=>i(""),5e3)}finally{f(!1)}},Me=t=>{k(t),N(!0)},P=async t=>{if(!(!a||!u))try{f(!0),i(""),d(!0);try{if((await y()).role!=="ADMIN")throw new Error("You no longer have admin privileges. Please refresh the page.")}finally{d(!1)}await W(a,u.id,t),x(`Member status changed to ${t} successfully!`),await b(a,I),N(!1),k(null),setTimeout(()=>x(""),3e3)}catch(s){const o=s instanceof Error?s.message:"Failed to change member status";i(o),setTimeout(()=>i(""),5e3)}finally{f(!1)}},H=()=>{N(!1),k(null)},we=(t,s)=>{a&&b(a,s)},_=t=>{switch(t){case"ACTIVE":return"success";case"DEACTIVATED":return"error";case"PENDING_VERIFY":return"warning";default:return"default"}},De=t=>t==="ADMIN"?"primary":"default";if(U||n)return e.jsxs(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",flexDirection:"column",gap:2},children:[e.jsx(Ee,{}),e.jsx(c,{children:U?"Loading workspace members...":"Validating admin privileges..."})]});if(w)return e.jsx(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh"},children:e.jsx(c,{color:"error",children:w})});const V=JSON.parse(localStorage.getItem("user")||"{}"),G=()=>{Te()};if(V.role!=="ADMIN")return e.jsx(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh"},children:e.jsx(c,{color:"error",variant:"h6",children:"Access denied. Admin role required."})});const q=Math.ceil(B/F);return e.jsxs(h,{sx:{display:"flex",minHeight:"100vh",bgcolor:"#f7f8fa"},children:[e.jsx(h,{sx:{display:{xs:"none",md:"block"}},children:e.jsx($,{userRole:V.role,currentTab:"users",onSignOut:G})}),e.jsx(Oe,{open:ge,onClose:()=>pe(!1),PaperProps:{sx:{width:240}},children:e.jsx($,{userRole:V.role,currentTab:"users",onSignOut:G,isDrawer:!0})}),e.jsxs(h,{sx:{flex:1,display:"flex",flexDirection:"column",ml:{xs:0,md:"220px"},minWidth:0,px:K.pagePx,py:K.pagePy},children:[e.jsxs(h,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,pt:{xs:2,md:3},fontFamily:'"Inter", "Roboto", "Helvetica", "Arial", sans-serif'},children:[e.jsxs(h,{children:[e.jsx(c,{sx:{fontWeight:D.title.weight,fontSize:{xs:D.title.xs,md:D.title.md},color:R.textPrimary},children:"Workspace Members"}),e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:1,mt:.5},children:[e.jsx(h,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:R.primary,opacity:.7}}),e.jsxs(c,{sx:{color:R.textSecondary,fontSize:D.caption.size},children:[B," members"]})]})]}),e.jsx(_e,{placeholder:"Search members...",size:"small",disabled:n,InputProps:{startAdornment:e.jsx(Ge,{position:"start",children:e.jsx(Ne,{sx:{color:n?"#ccc":"#bdbdbd"}})}),sx:{borderRadius:3,bgcolor:"#fff",width:{xs:220,sm:320},fontSize:16}},value:S,onChange:t=>ie(t.target.value)})]}),L&&e.jsx(v,{severity:"success",sx:{mb:2},children:L}),w&&e.jsx(v,{severity:"error",sx:{mb:2},action:w.includes("admin privileges")?e.jsx(g,{color:"inherit",size:"small",onClick:()=>window.location.reload(),children:"Refresh Page"}):void 0,children:w}),e.jsxs(qe,{elevation:0,sx:{borderRadius:3,p:{xs:2,md:3}},children:[e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsxs(Q,{size:"small",sx:{minWidth:140},children:[e.jsx(Z,{children:"Status"}),e.jsxs(ee,{value:E,label:"Status",disabled:n,onChange:t=>ue((t.target.value||"").toString().toUpperCase()),children:[e.jsx(M,{value:"",children:"All"}),e.jsx(M,{value:"ACTIVE",children:"Active"}),e.jsx(M,{value:"DEACTIVATED",children:"Deactivated"}),e.jsx(M,{value:"PENDING_VERIFY",children:"Pending Verify"})]})]}),e.jsxs(Q,{size:"small",sx:{minWidth:140},children:[e.jsx(Z,{children:"Role"}),e.jsxs(ee,{value:T,label:"Role",disabled:n,onChange:t=>fe((t.target.value||"").toString().toUpperCase()),children:[e.jsx(M,{value:"",children:"All"}),e.jsx(M,{value:"ADMIN",children:"Admin"}),e.jsx(M,{value:"MEMBER",children:"Member"})]})]})]}),e.jsx(ke,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(Pe,{size:"small",children:[e.jsx(Ve,{children:e.jsxs(X,{children:[e.jsx(m,{padding:"checkbox"}),e.jsx(m,{sx:{fontWeight:800,fontSize:{xs:14,md:16}},children:"Member ID"}),e.jsx(m,{sx:{fontWeight:800,fontSize:{xs:14,md:16}},children:"Name"}),e.jsx(m,{sx:{fontWeight:800,fontSize:{xs:14,md:16}},children:"Email"}),e.jsx(m,{sx:{fontWeight:800,fontSize:{xs:14,md:16}},children:"Role"}),e.jsx(m,{sx:{fontWeight:800,fontSize:{xs:14,md:16}},children:"Status"}),e.jsx(m,{sx:{fontWeight:800,fontSize:{xs:14,md:16}},children:"Joined"}),e.jsx(m,{align:"right"})]})}),e.jsx(Re,{children:p.map((t,s)=>e.jsxs(X,{children:[e.jsx(m,{padding:"checkbox",children:e.jsx(Xe,{checked:ne.includes(s),onChange:()=>be(s),disabled:n,icon:e.jsx(ze,{}),checkedIcon:e.jsx(We,{sx:{color:"#2950DA"}})})}),e.jsx(m,{sx:{fontWeight:700,fontSize:{xs:12,md:16},fontFamily:"monospace",whiteSpace:"nowrap"},children:t.id}),e.jsx(m,{sx:{fontWeight:600,fontSize:{xs:14,md:16}},children:t.name}),e.jsx(m,{sx:{fontWeight:600,fontSize:{xs:14,md:16}},children:t.email}),e.jsx(m,{children:e.jsx(z,{label:t.role,color:De(t.role),size:"small"})}),e.jsx(m,{children:e.jsx(z,{label:t.status,color:_(t.status),size:"small",onClick:()=>Me(t),disabled:n,sx:{cursor:n?"not-allowed":"pointer","&:hover":{opacity:n?1:.8,transform:n?"none":"scale(1.05)"}}})}),e.jsx(m,{sx:{fontWeight:600,fontSize:{xs:14,md:16}},children:new Date(t.createdAt).toLocaleDateString()}),e.jsx(m,{align:"right",children:e.jsx($e,{title:"View details",children:e.jsx(Ke,{onClick:()=>ye(t),disabled:n,children:e.jsx(Ue,{})})})})]},t.id))})]})}),q>1&&e.jsx(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",mt:3},children:e.jsx(Fe,{count:q,page:I,onChange:we,color:"primary",shape:"rounded",size:"large",disabled:n})})]})]}),e.jsxs(te,{open:de,onClose:Y,maxWidth:"sm",fullWidth:!0,children:[e.jsx(se,{children:"Member Details"}),e.jsx(re,{children:r?e.jsxs(h,{children:[e.jsxs(c,{children:[e.jsx("b",{children:"ID:"})," ",r.id]}),e.jsxs(c,{children:[e.jsx("b",{children:"Name:"})," ",r.name]}),e.jsxs(c,{children:[e.jsx("b",{children:"Email:"})," ",r.email]}),e.jsxs(c,{children:[e.jsx("b",{children:"Role:"})," ",r.role]}),e.jsxs(c,{children:[e.jsx("b",{children:"Status:"})," ",r.status]}),e.jsxs(c,{children:[e.jsx("b",{children:"Last Login:"})," ",r.lastLoginAt?new Date(r.lastLoginAt).toLocaleString():"Never"]}),e.jsxs(c,{children:[e.jsx("b",{children:"Joined:"})," ",new Date(r.createdAt).toLocaleString()]}),e.jsxs(h,{sx:{mt:3,display:"flex",gap:2,flexWrap:"wrap"},children:[r.status!=="ACTIVE"&&e.jsx(g,{color:"success",variant:"contained",onClick:()=>ve(r.id),disabled:j||n,children:"Activate Member"}),r.status==="ACTIVE"&&e.jsx(g,{color:"error",variant:"outlined",onClick:()=>Ie(r.id),disabled:j||n||r.role==="ADMIN",title:r.role==="ADMIN"?"Cannot deactivate an admin. Please change their role to Member first.":"Deactivate this member",children:"Deactivate Member"}),r.role==="MEMBER"&&e.jsx(g,{color:"primary",variant:"outlined",onClick:()=>J(r.id,"ADMIN"),disabled:j||n,children:"Make Admin"}),r.role==="ADMIN"&&e.jsx(g,{color:"warning",variant:"outlined",onClick:()=>J(r.id,"MEMBER"),disabled:j||n||p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1,title:p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1?"Cannot demote the only admin in the workspace":"Change role to Member",children:"Make Member"}),e.jsx(g,{color:"error",variant:"outlined",onClick:()=>Ae(r.id),disabled:j||n||r.role==="ADMIN"&&p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1||r.id===JSON.parse(localStorage.getItem("user")||"{}").id,title:r.role==="ADMIN"&&p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1?"Cannot deactivate the only admin from the workspace":r.id===JSON.parse(localStorage.getItem("user")||"{}").id?"Cannot deactivate yourself":"Deactivate this member from the workspace (soft delete)",children:"Deactivate"}),e.jsx(g,{color:"error",variant:"contained",onClick:()=>Ce(r.id),disabled:j||n||r.role==="ADMIN"&&p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1||r.id===JSON.parse(localStorage.getItem("user")||"{}").id,title:r.role==="ADMIN"&&p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1?"Cannot permanently delete the only admin from the workspace":r.id===JSON.parse(localStorage.getItem("user")||"{}").id?"Cannot permanently delete yourself":"Permanently delete this member and all their data (hard delete)",children:"Remove Permanently"})]}),r.role==="ADMIN"&&p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1&&e.jsx(v,{severity:"warning",sx:{mt:2},children:"This is the only admin in the workspace. At least one admin must remain to manage the workspace."}),r.role==="ADMIN"&&r.status==="ACTIVE"&&e.jsx(v,{severity:"info",sx:{mt:2},children:"Admins cannot be deactivated directly. Please change their role to Member first, then deactivate them."}),r.role==="ADMIN"&&p.filter(t=>t.role==="ADMIN"&&t.status==="ACTIVE").length===1&&e.jsx(v,{severity:"warning",sx:{mt:2},children:"This is the only admin in the workspace. At least one admin must remain to manage the workspace."}),e.jsxs(v,{severity:"info",sx:{mt:2},children:[e.jsx("strong",{children:"Deactivate:"})," Temporarily removes the member (soft delete). They can be reactivated later. ",e.jsx("br",{}),e.jsx("strong",{children:"Remove Permanently:"})," Completely deletes the member and all their data (hard delete). This action cannot be undone."]}),r.id===JSON.parse(localStorage.getItem("user")||"{}").id&&e.jsxs(v,{severity:"warning",sx:{mt:2},children:[e.jsx("strong",{children:"Note:"})," You cannot deactivate or permanently delete yourself. Ask another admin to perform these actions if needed."]})]}):e.jsx(c,{children:"No details available."})}),e.jsx(ae,{children:e.jsx(g,{onClick:Y,children:"Close"})})]}),e.jsxs(te,{open:xe,onClose:H,maxWidth:"sm",fullWidth:!0,children:[e.jsx(se,{children:"Change Member Status"}),e.jsx(re,{children:u?e.jsxs(h,{children:[e.jsxs(c,{sx:{mb:2},children:["Change status for"," ",e.jsx("strong",{children:u.name})," (",u.email,")"]}),e.jsxs(c,{sx:{mb:2},children:["Current status:"," ",e.jsx(z,{label:u.status,color:_(u.status),size:"small"})]}),e.jsx(c,{sx:{mb:2,color:"text.secondary"},children:"Select new status:"}),e.jsxs(h,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[u.status!=="ACTIVE"&&e.jsx(g,{color:"success",variant:"outlined",onClick:()=>P("ACTIVE"),disabled:j||n,children:"Activate"}),u.status==="ACTIVE"&&e.jsx(g,{color:"error",variant:"outlined",onClick:()=>P("DEACTIVATED"),disabled:j||n||u.role==="ADMIN",title:u.role==="ADMIN"?"Cannot deactivate an admin. Please change their role to Member first.":"Deactivate this member",children:"Deactivate"}),u.status!=="PENDING_VERIFY"&&e.jsx(g,{color:"warning",variant:"outlined",onClick:()=>P("PENDING_VERIFY"),disabled:j||n,children:"Set Pending Verify"})]}),u.role==="ADMIN"&&u.status==="ACTIVE"&&e.jsx(v,{severity:"info",sx:{mt:2},children:"Admins cannot be deactivated directly. Please change their role to Member first, then deactivate them."})]}):e.jsx(c,{children:"No member selected."})}),e.jsx(ae,{children:e.jsx(g,{onClick:H,children:"Cancel"})})]})]})};export{Mt as default};
