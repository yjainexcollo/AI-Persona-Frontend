import{j as o,B as p,T as l,r as h,k as G}from"./index-TH8YGKRz.js";import{H as J}from"./Header-DEoxuOro.js";import{S as K}from"./SearchBar-BX2JT_VK.js";import{U as Q,A as X,b as Y,C as Z}from"./ConversationSettingsDialog-DvKbdiOR.js";import{M as ee}from"./MoreVert-DIEecuZq.js";import{M as R,S as oe}from"./AdminSidebar-Bc6icHTo.js";import{A as te}from"./Avatar-BgeWc8dC.js";import{T as se}from"./Tooltip-CHKfBYiS.js";import{I as U}from"./IconButton-BAp8iDOQ.js";import{M as ne,a as re}from"./Menu-CzX3FVwN.js";import{g as ae,a as ie,b as ce,u as le,c as de,h as F}from"./personaService-jUulqpt0.js";import{g as he}from"./avatarService-BCG4JWCu.js";import{C as pe}from"./Container-DiviWFfv.js";import{P as me}from"./Paper-Mdtt8qvf.js";import{D as ge,a as xe,b as ve,c as fe}from"./DialogTitle-CKHsR478.js";import{T as ue}from"./TextField-Du34Z7EL.js";import{B as N}from"./Button-CJZqiG46.js";import"./index-DVvKU7GF.js";import"./SettingsPage-BRJXZXmu.js";import"./createSvgIcon-B0Pm_6cI.js";import"./createSvgIcon-1GfyKPJS.js";import"./useControlled-BLQOo7Av.js";import"./tokens-DkKdY8jA.js";import"./workspaceService-BQTsMTjt.js";import"./SwitchBase-GCTxqK2a.js";import"./Alert-DkG2QiTi.js";import"./useSlot-B20WKvL2.js";import"./resolveComponentProps-CAz9EWAT.js";import"./Grid-M9g4rATc.js";import"./Divider-7QTrz6EV.js";import"./getThemeProps-DA88l0eV.js";import"./Stack-DgAhbvWb.js";import"./useThemeProps-vG6R4auE.js";import"./InputAdornment-Cgg0GFqY.js";import"./ListItemText-DxyF1s_P.js";import"./Close-PlGpALEU.js";import"./Person-BCqWaaBP.js";import"./Chip-DQa8OeN4.js";const Se=({tab:m,onTabChange:r})=>o.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:3,mb:2,mt:1,ml:1.5},children:[o.jsx(l,{sx:{fontWeight:600,fontSize:17,color:m==="all"?"#2950DA":"#526794",borderBottom:m==="all"?"2.5px solid #2950DA":"2.5px solid transparent",pb:.5,cursor:"pointer",mr:2},onClick:()=>r("all"),children:"All"}),o.jsx(l,{sx:{fontWeight:600,fontSize:17,color:m==="archived"?"#2950DA":"#526794",borderBottom:m==="archived"?"2.5px solid #2950DA":"2.5px solid transparent",pb:.5,cursor:"pointer"},onClick:()=>r("archived"),children:"Archived"})]}),Ce=({avatar:m,name:r,message:u,date:S,archived:i=!1,onClick:y,onRightClick:g,onArchive:v,onUnarchive:C,onShare:I,onConversationSettings:A})=>{const[D,b]=h.useState(null),E=a=>{a.preventDefault(),a.stopPropagation(),b(a.currentTarget)},f=()=>{b(null)},k=a=>{a.preventDefault(),a.stopPropagation(),I&&I(),f()},j=a=>{a.preventDefault(),a.stopPropagation(),A&&A(),f()};return o.jsxs(p,{sx:{display:"flex",alignItems:"center",py:1.2,px:0,borderRadius:2,cursor:"pointer","&:hover":{background:i?"#F0F2F5":"#F5F7FA"},opacity:i?.8:1,backgroundColor:i?"#F8F9FA":"transparent",border:i?"1px solid #E1E5E9":"none",position:"relative","&::before":i?{content:'""',position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#9CA3AF",borderRadius:"2px 0 0 2px"}:{}},onClick:y,onContextMenu:a=>{a.preventDefault(),g&&g()},children:[o.jsx(te,{src:m,sx:{width:48,height:48,mr:2,ml:.5}}),o.jsxs(p,{sx:{flex:1,minWidth:0,ml:.5},children:[o.jsx(l,{sx:{fontWeight:700,fontSize:17,color:"#222",lineHeight:1.1},children:r}),o.jsx(l,{sx:{color:"#2950DA",fontWeight:400,fontSize:15,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:400},children:u})]}),o.jsx(l,{sx:{color:"#526794",fontWeight:400,fontSize:15,minWidth:70,textAlign:"right",ml:0,mr:1},children:S}),o.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(v||C)&&o.jsx(se,{title:i?"Unarchive":"Archive",children:o.jsx(U,{size:"small",onClick:a=>{a.stopPropagation(),i&&C?C():!i&&v&&v()},sx:{color:i?"#2950DA":"#666",backgroundColor:i?"rgba(41, 80, 218, 0.1)":"transparent","&:hover":{color:i?"#1E40AF":"#333",backgroundColor:i?"rgba(41, 80, 218, 0.2)":"rgba(0, 0, 0, 0.04)"},border:i?"1px solid rgba(41, 80, 218, 0.3)":"none",transition:"all 0.2s ease-in-out"},children:i?o.jsx(Q,{}):o.jsx(X,{})})}),o.jsx(U,{size:"small",onClick:E,sx:{color:"#666",p:"4px","&:hover":{color:"#1976d2",backgroundColor:"rgba(25, 118, 210, 0.08)"}},children:o.jsx(ee,{sx:{fontSize:16}})})]}),o.jsxs(ne,{anchorEl:D,open:!!D,onClose:f,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[o.jsxs(R,{onClick:a=>k(a),children:[o.jsx(Y,{sx:{mr:1}})," Share"]}),o.jsxs(R,{onClick:a=>j(a),children:[o.jsx(oe,{sx:{mr:1}})," Conversation Settings"]})]})]})},Ae=({chats:m})=>o.jsx(p,{ml:2,children:m.map((r,u)=>o.jsx(p,{sx:{mb:.5},children:o.jsx(Ce,{avatar:r.avatar,name:r.name,message:r.message,date:r.date,archived:r.archived,onClick:r.onClick,onRightClick:r.onRightClick,onArchive:r.onArchive,onUnarchive:r.onUnarchive,onShare:r.onShare,onConversationSettings:r.onConversationSettings})},u))}),ao=()=>{const m=G(),[r,u]=h.useState("all"),[S,i]=h.useState(""),[y,g]=h.useState([]),[v,C]=h.useState(null),[I,A]=h.useState(!1),[D,b]=h.useState([]),[E,f]=h.useState(!1),[k,j]=h.useState(!1),[a,P]=h.useState(""),[W,T]=h.useState(null);h.useEffect(()=>{async function t(){try{const e=await ae();b(e.data||[])}catch(e){console.error("Error fetching personas from backend:",e),b([])}}t()},[]);const L=async t=>{const e=t.personaId,n=t.conversation_id,s=t.sessionId;if(e&&n){const d=s?`/chat/${e}?conversationId=${n}&sessionId=${s}`:`/chat/${e}?conversationId=${n}`;m(d)}else console.error(`Persona ID or conversation ID not found for session: ${t.conversation_id}`)};h.useEffect(()=>{console.log("Starting chat history fetch for tab:",r),(async()=>{try{console.log("Fetching chat sessions from backend API");const e=await ie();if(console.log("Chat sessions fetched from backend:",e),e&&e.length>0){const n=e.map(s=>{const d=s.messages||[],c=d[d.length-1];return{conversation_id:s.conversation.id,persona:s.persona.name,personaId:s.persona.id,sessionId:s.sessionId,last_message:(c==null?void 0:c.content)||"No messages",date:new Date(s.conversation.updatedAt).toLocaleDateString(),chats:d.map(x=>({persona:s.persona.name,user_message:x.role==="USER"?x.content:"",ai_response:x.role==="ASSISTANT"?x.content:"",timestamp:x.createdAt,conversation_id:s.conversation.id,archived:!!s.conversation.archivedAt})),archived:!!s.conversation.archivedAt,lastTimestamp:s.conversation.updatedAt}});n.sort((s,d)=>new Date(d.lastTimestamp).getTime()-new Date(s.lastTimestamp).getTime()),console.log("Sessions created:",n.length),console.log("All sessions:",n.map(s=>({conversation_id:s.conversation_id,persona:s.persona,count:s.chats.length,archived:s.archived}))),g(n)}else{console.log("No chat sessions found, falling back to conversations list");try{const n=await ce(r==="archived"),d=((n==null?void 0:n.data)||[]).map(c=>{var w,H;const x=c.lastMessage||"No messages";return{conversation_id:c.id,persona:((w=c.persona)==null?void 0:w.name)||"Unknown Persona",personaId:(H=c.persona)==null?void 0:H.id,sessionId:"",last_message:x,date:new Date(c.updatedAt).toLocaleDateString(),chats:[],archived:!!c.archivedAt,lastTimestamp:c.updatedAt}});d.sort((c,x)=>new Date(x.lastTimestamp).getTime()-new Date(c.lastTimestamp).getTime()),g(d)}catch(n){console.error("Fallback to conversations failed:",n),g([])}}}catch(e){console.error("Error fetching chat sessions:",e),g([])}})()},[r]);const M=y.filter(t=>{const e=t.persona.toLowerCase().includes(S.toLowerCase())||t.last_message.toLowerCase().includes(S.toLowerCase()),n=r==="all"?!t.archived:t.archived;return console.log("Filtering session:",{id:t.conversation_id,persona:t.persona,archived:t.archived,tab:r,matchesSearch:e,matchesTab:n,finalResult:e&&n}),e&&n}),O=async t=>{console.log("Share button clicked for conversation:",t);try{try{await le(t,"SHARED")}catch(s){console.warn("Failed to set visibility to SHARED before sharing:",s)}const n=(await de(t)).data.url;P(n),j(!0);try{await navigator.clipboard.writeText(n),console.log("Share link copied to clipboard:",n)}catch{}}catch(e){console.error("Error creating share link:",e)}},z=t=>{const e=y.find(n=>n.conversation_id===t);if(e){const n={id:e.conversation_id,title:e.persona,persona:{id:e.personaId,name:e.persona},personaId:e.personaId,userId:"",user:{id:"",name:"",email:""},messages:e.chats.map(s=>({id:s.timestamp,content:s.user_message||s.ai_response,role:s.user_message?"USER":"ASSISTANT",createdAt:s.timestamp,updatedAt:s.timestamp})),createdAt:e.lastTimestamp,updatedAt:e.lastTimestamp,archivedAt:e.archived?e.lastTimestamp:null,visibility:"PRIVATE",_count:{messages:e.chats.length}};T(n),f(!0)}},B=async t=>{try{console.log("=== ARCHIVE HANDLER: Starting archive ==="),console.log("Session:",t.conversation_id);const e=await F(t.conversation_id,!0);console.log("Archive successful:",e),g(n=>n.map(s=>s.conversation_id===t.conversation_id?{...s,archived:!0}:s)),console.log("=== ARCHIVE HANDLER: Archive completed ===")}catch(e){console.error("=== ARCHIVE HANDLER: Archive failed ==="),console.error("Error:",e instanceof Error?e.message:String(e)),alert(`Failed to archive conversation: ${e instanceof Error?e.message:String(e)}`)}},V=async t=>{try{console.log("=== UNARCHIVE HANDLER: Starting unarchive ==="),console.log("Session:",t.conversation_id);const e=await F(t.conversation_id,!1);console.log("Unarchive successful:",e),g(n=>n.map(s=>s.conversation_id===t.conversation_id?{...s,archived:!1}:s)),console.log("=== UNARCHIVE HANDLER: Unarchive completed ===")}catch(e){console.error("=== UNARCHIVE HANDLER: Unarchive failed ==="),console.error("Error:",e instanceof Error?e.message:String(e)),alert(`Failed to unarchive conversation: ${e instanceof Error?e.message:String(e)}`)}},$=(t,e)=>{g(n=>n.map(s=>s.conversation_id===t?{...s,archived:!!e.archivedAt,lastTimestamp:e.updatedAt||s.lastTimestamp}:s))},q=()=>{f(!1),T(null)},_=M.map((t,e)=>{console.log("Mapping session:",t);const n=D.find(c=>c.id===t.personaId);console.log("Found persona for session:",n);const d={avatar:he((n==null?void 0:n.avatarUrl)||(n==null?void 0:n.avatar)||"")||"",name:(n==null?void 0:n.name)||`Persona: ${t.persona}`,message:t.last_message,date:t.date,archived:t.archived,onClick:()=>{console.log("Session clicked:",t),L(t)},onRightClick:()=>{C(t),A(!0)},onArchive:()=>B(t),onUnarchive:()=>V(t),onShare:()=>O(t.conversation_id),onConversationSettings:()=>z(t.conversation_id),key:t.conversation_id+"-"+e};return console.log("Created chat object:",d),d});return console.log("Chats array for UI:",_),o.jsxs(p,{sx:{minHeight:"100vh",backgroundColor:"#ffffff"},children:[o.jsx(J,{}),o.jsxs(pe,{sx:{py:{xs:2,md:4},maxWidth:900},children:[o.jsx(p,{sx:{width:"100%",mx:"auto",mb:2,px:{xs:0,md:1}},children:o.jsx(K,{value:S,onChange:i,placeholder:"Search",fullWidth:!0,maxWidth:1200})}),o.jsx(p,{sx:{px:{xs:0,md:1}},children:o.jsx(Se,{tab:r,onTabChange:u})}),_.length>0?o.jsx(Ae,{chats:_}):o.jsxs(p,{sx:{textAlign:"center",py:4,color:"#666"},children:[o.jsx(l,{variant:"h6",children:"No chat history found"}),o.jsx(l,{variant:"body2",sx:{mt:1},children:"Start chatting with personas to see your conversation history here."})]}),o.jsx(re,{open:I,onClose:()=>A(!1),children:o.jsxs(me,{sx:{maxWidth:600,mx:"auto",my:8,p:4,outline:"none"},children:[o.jsx(l,{variant:"h6",sx:{mb:2},children:"Session Details"}),v&&v.chats.length>0?v.chats.map((t,e)=>o.jsxs(p,{sx:{mb:2,p:2,bgcolor:"#f5f5f5",borderRadius:2},children:[o.jsxs(l,{sx:{fontWeight:700},children:["Persona: ",t.persona]}),o.jsxs(l,{sx:{color:"#333",mt:1},children:["User: ",t.user_message]}),o.jsxs(l,{sx:{color:"#2950DA",mt:1},children:["AI: ",t.ai_response]}),o.jsx(l,{sx:{color:"#888",fontSize:13,mt:1},children:new Date(t.timestamp).toLocaleString()})]},e)):o.jsx(l,{children:"No messages in this session."})]})}),o.jsx(Z,{open:E,onClose:q,conversation:W,onConversationUpdate:$}),o.jsxs(ge,{open:k,onClose:()=>j(!1),maxWidth:"sm",fullWidth:!0,children:[o.jsx(xe,{children:"Share Conversation"}),o.jsxs(ve,{children:[o.jsx(l,{sx:{mb:1},children:"Shareable link (copied to clipboard):"}),o.jsx(ue,{fullWidth:!0,value:a,InputProps:{readOnly:!0}})]}),o.jsxs(fe,{children:[o.jsx(N,{onClick:async()=>{try{await navigator.clipboard.writeText(a)}catch{}},variant:"outlined",children:"Copy"}),o.jsx(N,{onClick:()=>j(!1),variant:"contained",children:"Close"})]})]})]})]})};export{ao as default};
