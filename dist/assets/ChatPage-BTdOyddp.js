import{g as Lt,a as Mt,r as n,u as _t,_ as Tt,b as Be,j as e,s as Ft,c as Ot,d as ft,e as $t,f as X,h as Q,i as J,k as Ne,l as Ut,m as pt,R as _e,B as i,n as Ht,T as p,C as Ie,o as Pt,p as qt,q as Bt,t as Je}from"./index-TH8YGKRz.js";import{r as Z}from"./createSvgIcon-B0Pm_6cI.js";import{E as Nt}from"./Edit-CoZH97Fq.js";import{C as Kt}from"./Close-PlGpALEU.js";import{M as Vt,S as Gt}from"./SettingsPage-BRJXZXmu.js";import{A as Yt,T as Xt,C as Qt}from"./index-DVvKU7GF.js";import{L as Jt,M as Ze}from"./AdminSidebar-Bc6icHTo.js";import{u as ut,D as mt}from"./Divider-7QTrz6EV.js";import{I as H}from"./IconButton-BAp8iDOQ.js";import{S as Zt}from"./Stack-DgAhbvWb.js";import{B as V}from"./Button-CJZqiG46.js";import{D as Ke,a as gt,b as vt,c as bt}from"./DialogTitle-CKHsR478.js";import{A as de}from"./Avatar-BgeWc8dC.js";import{P as es,L as ce,M as ts,a as ss}from"./Menu-CzX3FVwN.js";import{L as F,a as et,b as K}from"./ListItemText-DxyF1s_P.js";import{g as yt,a as jt,u as rs,c as os,t as is,b as tt,d as ns,e as st,f as as,s as ls}from"./personaService-jUulqpt0.js";import{C as wt,a as St,S as cs}from"./ConversationSettingsDialog-DvKbdiOR.js";import{C as ds}from"./ChevronLeft-Cxf_Y_9m.js";import{c as Te}from"./createSvgIcon-1GfyKPJS.js";import{L as ue,u as xs}from"./useAuth-FXh2IcXF.js";import{P as hs,F as fs}from"./FormattedOutput-Bz9VY3_B.js";import{S as ps}from"./Settings-BKj_EDFP.js";import{T as It,I as us}from"./TextField-Du34Z7EL.js";import{C as ms}from"./ChatInputBar-ToCd21nW.js";import{P as gs}from"./Paper-Mdtt8qvf.js";import{g as vs}from"./workspaceService-BQTsMTjt.js";import{T as rt}from"./Tooltip-CHKfBYiS.js";import{A as kt}from"./Alert-DkG2QiTi.js";import"./useControlled-BLQOo7Av.js";import"./tokens-DkKdY8jA.js";import"./SwitchBase-GCTxqK2a.js";import"./Grid-M9g4rATc.js";import"./getThemeProps-DA88l0eV.js";import"./useThemeProps-vG6R4auE.js";import"./useSlot-B20WKvL2.js";import"./resolveComponentProps-CAz9EWAT.js";import"./Person-BCqWaaBP.js";import"./Chip-DQa8OeN4.js";function bs(r){return Lt("MuiListSubheader",r)}Mt("MuiListSubheader",["root","colorPrimary","colorInherit","gutters","inset","sticky"]);const ys=["className","color","component","disableGutters","disableSticky","inset"],js=r=>{const{classes:o,color:c,disableGutters:g,inset:b,disableSticky:t}=r,S={root:["root",c!=="default"&&`color${ft(c)}`,!g&&"gutters",b&&"inset",!t&&"sticky"]};return $t(S,bs,o)},ws=Ft("li",{name:"MuiListSubheader",slot:"Root",overridesResolver:(r,o)=>{const{ownerState:c}=r;return[o.root,c.color!=="default"&&o[`color${ft(c.color)}`],!c.disableGutters&&o.gutters,c.inset&&o.inset,!c.disableSticky&&o.sticky]}})(({theme:r,ownerState:o})=>Be({boxSizing:"border-box",lineHeight:"48px",listStyle:"none",color:(r.vars||r).palette.text.secondary,fontFamily:r.typography.fontFamily,fontWeight:r.typography.fontWeightMedium,fontSize:r.typography.pxToRem(14)},o.color==="primary"&&{color:(r.vars||r).palette.primary.main},o.color==="inherit"&&{color:"inherit"},!o.disableGutters&&{paddingLeft:16,paddingRight:16},o.inset&&{paddingLeft:72},!o.disableSticky&&{position:"sticky",top:0,zIndex:1,backgroundColor:(r.vars||r).palette.background.paper})),Me=n.forwardRef(function(o,c){const g=_t({props:o,name:"MuiListSubheader"}),{className:b,color:t="default",component:S="li",disableGutters:L=!1,disableSticky:D=!1,inset:u=!1}=g,A=Tt(g,ys),R=Be({},g,{color:t,component:S,disableGutters:L,disableSticky:D,inset:u}),M=js(R);return e.jsx(ws,Be({as:S,className:Ot(M.root,b),ref:c,ownerState:R},A))});Me.muiSkipListHighlight=!0;var me={},ot;function Ss(){if(ot)return me;ot=1;var r=X();Object.defineProperty(me,"__esModule",{value:!0}),me.default=void 0;var o=r(Z()),c=Q();return me.default=(0,o.default)((0,c.jsx)("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"ChevronLeft"),me}var Is=Ss();const ks=J(Is);var ge={},it;function Cs(){if(it)return ge;it=1;var r=X();Object.defineProperty(ge,"__esModule",{value:!0}),ge.default=void 0;var o=r(Z()),c=Q();return ge.default=(0,o.default)((0,c.jsx)("path",{d:"M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),"Check"),ge}var As=Cs();const nt=J(As);var ve={},at;function Ws(){if(at)return ve;at=1;var r=X();Object.defineProperty(ve,"__esModule",{value:!0}),ve.default=void 0;var o=r(Z()),c=Q();return ve.default=(0,o.default)((0,c.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack"),ve}var Es=Ws();const Ds=J(Es);var be={},lt;function Rs(){if(lt)return be;lt=1;var r=X();Object.defineProperty(be,"__esModule",{value:!0}),be.default=void 0;var o=r(Z()),c=Q();return be.default=(0,o.default)((0,c.jsx)("path",{d:"M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4"}),"HelpOutline"),be}var zs=Rs();const Ls=J(zs),Ms=({onBack:r,onMenu:o,isSidebarOpen:c,backIcon:g})=>{const b=Ne(),t=Ut(),S=pt(),L=ut(S.breakpoints.down("md")),D=280,[u,A]=_e.useState(null),R=!!u,M=C=>{A(C.currentTarget)},_=()=>{A(null)},f=()=>{_(),Ht()},[v,w]=_e.useState(!1),z=()=>w(!0),W=()=>w(!1);return e.jsxs(Yt,{position:"relative",elevation:0,sx:{backgroundColor:"#fff",color:"#333",boxShadow:"none",borderBottom:"1px solid #e9ecef"},children:[e.jsxs(Xt,{sx:{justifyContent:"space-between",px:{xs:2,sm:3},minHeight:{xs:56,sm:64}},children:[c&&e.jsx(i,{sx:{width:`${D}px`,flexShrink:0}}),e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:.5,transition:"margin-left 0.3s cubic-bezier(.4,0,.2,1)"},children:!c&&e.jsxs(e.Fragment,{children:[e.jsx(H,{size:"small",onClick:r,"aria-label":"Go back",sx:{fontSize:{xs:24,sm:28},color:"#000",fontWeight:900,fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif",p:{xs:.8,sm:1},mr:.2,background:"none",border:"none",borderRadius:0,boxShadow:"none","&:hover":{color:"#2950DA",background:"none"}},children:typeof g<"u"?g:e.jsx(Ds,{})}),e.jsx(H,{size:"small","aria-label":"Open menu",sx:{color:"#000",fontSize:{xs:20,sm:22},fontWeight:900,fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif",p:{xs:.6,sm:.7},ml:.2,background:"none",border:"none",borderRadius:0,boxShadow:"none","&:hover":{color:"#2950DA",background:"none"}},onClick:o,children:e.jsx(Vt,{sx:{fontSize:{xs:20,sm:22},fontWeight:900}})})]})}),e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:4,flex:1,mx:{xs:2,sm:4}}}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:1}},children:[!L&&e.jsxs(Zt,{direction:"row",children:[e.jsx(V,{sx:{color:t.pathname==="/discovery"?"#2950DA":"#666",fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif",fontWeight:500,fontSize:"16px",lineHeight:"24px",letterSpacing:0,textTransform:"none","&:hover":{backgroundColor:"transparent",color:"#2950DA"}},onClick:()=>b("/discovery"),children:"Discover"}),e.jsx(V,{sx:{color:t.pathname==="/chat-history"?"#2950DA":"#666",fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif",fontWeight:500,fontSize:"16px",lineHeight:"24px",letterSpacing:0,textTransform:"none","&:hover":{backgroundColor:"transparent",color:"#2950DA"}},onClick:()=>b("/chat-history"),children:"Chat History"}),e.jsx(V,{sx:{color:t.pathname==="/"?"#2950DA":"#666",fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif",fontWeight:500,fontSize:"16px",lineHeight:"24px",letterSpacing:0,textTransform:"none","&:hover":{backgroundColor:"transparent",color:"#2950DA"}},onClick:()=>b("/"),children:"My Workspace"})]}),e.jsxs(e.Fragment,{children:[e.jsx(H,{sx:{color:"#666"},onClick:z,"aria-label":"Open settings",children:e.jsx(Qt,{size:L?20:24})}),e.jsx(Ke,{open:v,onClose:W,fullScreen:!0,"aria-labelledby":"settings-dialog-title",PaperProps:{sx:{m:0,borderRadius:0,width:"100%",height:"100%",overflow:"hidden"}},children:e.jsx(Gt,{})})]}),e.jsx(V,{onClick:M,sx:{minWidth:0,p:.5},"aria-haspopup":"menu","aria-expanded":R?"true":void 0,"aria-label":"Open profile menu",children:e.jsx(de,{src:"",sx:{width:{xs:28,sm:32},height:{xs:28,sm:32}},imgProps:{loading:"lazy"}})})]})]}),e.jsx(es,{open:R,anchorEl:u,onClose:_,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},PaperProps:{sx:{mt:1,minWidth:200,boxShadow:"0 4px 20px rgba(0,0,0,0.15)",borderRadius:3}},children:e.jsxs(ce,{sx:{py:0},children:[e.jsxs(F,{button:!0,children:[e.jsx(et,{children:e.jsx(Ls,{})}),e.jsx(K,{primary:"Help & Support"})]}),e.jsx(mt,{}),e.jsxs(F,{button:!0,onClick:f,children:[e.jsx(et,{children:e.jsx(Jt,{})}),e.jsx(K,{primary:"Logout"})]})]})})]})},_s=Te(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),Ts=Te(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"}),"MoreVert"),Fs=Te(e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"}),"Search"),Os=Te(e.jsx("path",{d:"M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92"}),"Share"),$s=({onClose:r,currentPersonaId:o,currentConversationId:c,onSearchChats:g,activePersona:b,activeLastMessage:t})=>{var Y,se;const S=Ne(),[L,D]=n.useState([]),[u,A]=n.useState([]),[R,M]=n.useState(!1),[_,f]=n.useState([]),[v,w]=n.useState(!1),[z]=n.useState(""),[W,C]=n.useState(null),[$,G]=n.useState(null),[O,ee]=n.useState(!1),[ie,ne]=n.useState(null),[ae,q]=n.useState(!1),[Fe,ke]=n.useState("");n.useEffect(()=>{async function x(){try{const m=await yt();D(m.data||[])}catch(m){console.error("Error fetching personas from backend:",m),D([])}}x()},[]),n.useEffect(()=>{(async()=>{M(!0);try{const m=L.filter(I=>I.isFavourited).map(I=>({id:I.id,name:I.name,personalName:I.personalName,avatar:I.avatarUrl||I.avatar||"",role:I.name||""}));A(m)}catch(m){console.error("Error fetching favorites:",m),A([])}M(!1)})()},[L]),n.useEffect(()=>{(async()=>{w(!0);try{let k=(await jt()||[]).map(h=>{var fe,re,pe,N,Ce,Ae,We,Ee,De,Re,ze,Le;const P=(h.messages||[]).slice(-1)[0];return(fe=h.conversation)!=null&&fe.id?{id:h.conversation.id,title:((re=h.conversation)==null?void 0:re.title)||"",userId:((pe=h.user)==null?void 0:pe.id)||"",personaId:((N=h.persona)==null?void 0:N.id)||((Ce=h.conversation)==null?void 0:Ce.personaId)||"",visibility:((Ae=h.conversation)==null?void 0:Ae.visibility)||"PRIVATE",archivedAt:((We=h.conversation)==null?void 0:We.archivedAt)||null,createdAt:((Ee=h.conversation)==null?void 0:Ee.createdAt)||new Date().toISOString(),updatedAt:((De=h.conversation)==null?void 0:De.updatedAt)||new Date().toISOString(),persona:{id:((Re=h.persona)==null?void 0:Re.id)||"",name:((ze=h.persona)==null?void 0:ze.name)||"",avatarUrl:((Le=h.persona)==null?void 0:Le.avatarUrl)||""},user:h.user||{id:"",name:"",email:""},messages:h.messages||[],_count:{messages:(h.messages||[]).length},lastMessage:P?P.content||P.text:"",sessionId:h.sessionId}:null}).filter(h=>h!==null);o&&(k=k.filter(h=>h.personaId===o)),k=k.sort((h,P)=>new Date(P.updatedAt).getTime()-new Date(h.updatedAt).getTime()).slice(0,10),f(k)}catch(m){console.error("Error fetching recent chats:",m),f([])}w(!1)})()},[o]);const T=()=>{const x=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;if(o){S(`/chat/${o}?draft=${x}`),r&&r();return}const m=L[0];if(m){S(`/chat/${m.id}?draft=${x}`),r&&r();return}S("/discovery"),r&&r()},le=x=>{S(`/chat/${x}`),r&&r()},Oe=()=>{g&&g(),r&&r()},$e=async(x,m)=>{var I;try{(I=m==null?void 0:m.stopPropagation)==null||I.call(m)}catch{}console.log("Share button clicked for conversation:",x);try{try{await rs(x,"SHARED")}catch(P){console.warn("Failed to set visibility to SHARED before sharing:",P)}const h=(await os(x)).data.url;ke(h),q(!0);try{await navigator.clipboard.writeText(h),console.log("Share link copied to clipboard:",h)}catch{}}catch(k){console.error("Error creating share link:",k),ke("Failed to generate link. Try again."),q(!0)}},Ue=(x,m)=>{x.stopPropagation(),C(x.currentTarget),G(m)},B=()=>{C(null),G(null)},He=x=>{const m=_.find(I=>I.id===x);m&&(ne(m),ee(!0)),B()},te=(x,m)=>{f(I=>I.map(k=>k.id===x?{...k,...m}:k))},Pe=()=>{ee(!1),ne(null)},xe=x=>{const m=x.personaId,I=x.id,k=x.sessionId;if(m&&I){const h=k?`/chat/${m}?conversationId=${I}&sessionId=${k}`:`/chat/${m}?conversationId=${I}`;S(h),r&&r()}};let U=c&&_.length&&_.find(x=>x.id===c)||null;!U&&b&&(U={id:c||`draft-${b.id}`,title:"",userId:"",personaId:b.id,visibility:"PRIVATE",archivedAt:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),persona:{id:b.id,name:b.name,avatarUrl:b.avatarUrl||""},user:{id:"",name:"",email:""},messages:[],_count:{messages:0},lastMessage:t||""});const he=U?_.filter(x=>x.id!==U.id):_;return e.jsxs(i,{sx:{width:{xs:"86vw",sm:280,md:280},maxWidth:"100vw",height:"100vh",bgcolor:"#fff",p:0,boxSizing:"border-box",display:"flex",flexDirection:"column",borderRight:"1px solid #e0e0e0",overflowY:"auto",overflowX:"hidden",fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"}},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:{xs:2,sm:3},px:0,py:{xs:1,sm:1.5},mt:{xs:1,sm:1.8},pt:0,pl:{xs:1.5,sm:2}},children:[e.jsx(H,{onClick:r,sx:{color:"#012A1F",fontSize:{xs:24,sm:28},p:0,minWidth:{xs:40,sm:32},minHeight:{xs:40,sm:32},mr:.2,fontWeight:900},children:e.jsx(ds,{sx:{fontSize:{xs:24,sm:28},color:"#012A1F"}})}),e.jsx(p,{variant:"h6",sx:{fontWeight:700,color:"#012A1F",fontSize:{xs:20,sm:22},whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",ml:{xs:1,sm:1.2}},children:e.jsx("img",{src:"/logo.png",alt:"Logo",style:{height:"20px",width:"auto",verticalAlign:"middle",cursor:"pointer"}})})]}),e.jsx(V,{variant:"contained",size:"medium",startIcon:e.jsx(_s,{sx:{fontSize:18}}),"aria-label":"Start a new chat",sx:{background:"linear-gradient(90deg, #2950DA 0%, #1E88E5 100%)",color:"#fff",borderRadius:2,fontWeight:700,fontSize:{xs:15,sm:16},py:{xs:1.3,sm:3},mb:{xs:1.5,sm:1.8},mt:{xs:1.5,sm:2},boxShadow:"0 4px 12px rgba(41,80,218,0.18)",textTransform:"none",width:"calc(100% - 95px)",minWidth:0,letterSpacing:.2,mx:2,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",transition:"transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease","&:hover":{transform:"translateY(-1px)",boxShadow:"0 6px 16px rgba(41,80,218,0.25)",background:"linear-gradient(90deg, #1E6FE5 0%, #2950DA 100%)"},"&:disabled":{background:"#b0bec5",color:"#f5f5f5"}},onClick:T,children:"New chat"}),e.jsxs(ce,{sx:{mb:{xs:2,sm:2.5},mx:{xs:1.5,sm:2},width:"100%",maxWidth:"100%"},children:[e.jsxs(F,{button:!0,sx:{px:0,mb:{xs:1,sm:1.2},minWidth:0},onClick:()=>S(`/view-persona/${o||L[0]&&L[0].id}`),children:[e.jsx(ue,{sx:{minWidth:{xs:40,sm:32}},children:e.jsx(hs,{sx:{color:"#222",fontSize:{xs:24,sm:22},marginTop:.5}})}),e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#222",fontSize:{xs:15,sm:16},whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:"View Persona"})})]}),e.jsxs(F,{button:!0,sx:{px:0,minWidth:0},onClick:Oe,children:[e.jsx(ue,{sx:{minWidth:{xs:40,sm:32}},children:e.jsx(Fs,{sx:{color:"#222",fontSize:{xs:24,sm:22},marginTop:.5}})}),e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#222",fontSize:{xs:15,sm:16},whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:"Search Chats"})})]})]}),e.jsx(ce,{sx:{mb:{xs:1.5,sm:2},mx:{xs:1.5,sm:2},width:"100%",maxWidth:"100%"},subheader:e.jsx(Me,{component:"div",disableSticky:!0,sx:{bgcolor:"transparent",fontWeight:800,color:"#111",fontSize:{xs:20,sm:22},letterSpacing:-1,px:0,py:.1,mt:-1.2,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:"Favorite Personas"}),children:R?e.jsx(F,{sx:{px:0,py:{xs:1,sm:1.2},minWidth:0},children:e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#888",fontSize:{xs:14,sm:15},fontStyle:"italic"},children:"Loading favorites..."})})}):u.length>0?u.map(x=>e.jsxs(F,{button:!0,sx:{px:0,py:{xs:1,sm:1.2},minWidth:0},onClick:()=>le(x.id),children:[e.jsx(ue,{sx:{minWidth:{xs:44,sm:36}},children:e.jsx(de,{src:x.avatar||"",sx:{width:{xs:36,sm:32},height:{xs:36,sm:32},mr:1}})}),e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#222",fontSize:{xs:14,sm:15},whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:x.personalName||x.name}),secondary:x.name&&e.jsx(p,{sx:{color:"#666",fontSize:{xs:12,sm:13},whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:x.name})})]},x.id)):e.jsx(F,{sx:{px:0,py:{xs:1,sm:1.2},minWidth:0},children:e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#888",fontSize:{xs:14,sm:15},fontStyle:"italic"},children:"No favorite personas yet"})})})}),U&&e.jsx(ce,{sx:{mx:{xs:1.5,sm:2},width:"100%",maxWidth:"100%",mb:1},subheader:e.jsx(Me,{component:"div",disableSticky:!0,sx:{bgcolor:"transparent",fontWeight:800,color:"#111",fontSize:{xs:18,sm:20},letterSpacing:-1,px:0,py:.5,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"100%"},children:"Active Chat"}),children:e.jsxs(F,{button:!0,sx:{px:0,py:{xs:1,sm:1.2},minWidth:0,display:"flex",alignItems:"center",gap:1,overflow:"visible",bgcolor:"#EEF3FF",borderRadius:1.5},onClick:()=>xe(U),children:[e.jsx(ue,{sx:{minWidth:36,flexShrink:0},children:e.jsx(de,{src:((Y=U.persona)==null?void 0:Y.avatarUrl)||"",sx:{width:28,height:28,mr:1}})}),e.jsxs(i,{sx:{flex:1,minWidth:0,overflow:"visible",display:"flex",flexDirection:"column",pr:1},children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",width:"100%",mb:0},children:e.jsx(p,{sx:{fontWeight:600,color:"#1E3A8A",fontSize:14,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:"1 1 0%",minWidth:0,maxWidth:"calc(100% - 40px)",mr:0},children:((se=U.persona)==null?void 0:se.name)||"Unknown Persona"})}),e.jsx(p,{sx:{color:"#1E3A8A",fontSize:12,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:0},children:U.lastMessage||"No messages"})]})]})}),e.jsx(ce,{sx:{mx:{xs:1.5,sm:2},width:"100%",maxWidth:"100%"},subheader:e.jsx(Me,{component:"div",disableSticky:!0,sx:{bgcolor:"transparent",fontWeight:800,color:"#111",fontSize:{xs:18,sm:20},letterSpacing:-1,px:0,py:.5,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"100%"},children:z?`${z} Chats`:"Recent Chats"}),children:v?e.jsx(F,{sx:{px:0,py:{xs:1,sm:1.2},minWidth:0},children:e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#888",fontSize:{xs:14,sm:15},fontStyle:"italic"},children:"Loading recent chats..."})})}):he.length>0?he.map(x=>{var m,I;return e.jsxs(F,{button:!0,sx:{px:0,py:{xs:1,sm:1.2},minWidth:0,display:"flex",alignItems:"center",gap:1,overflow:"visible"},onClick:()=>xe(x),children:[e.jsx(ue,{sx:{minWidth:36,flexShrink:0},children:e.jsx(de,{src:((m=x.persona)==null?void 0:m.avatarUrl)||"",sx:{width:28,height:28,mr:1}})}),e.jsxs(i,{sx:{flex:1,minWidth:0,overflow:"visible",display:"flex",flexDirection:"column",pr:1},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",width:"100%",mb:0},children:[e.jsx(p,{sx:{fontWeight:500,color:"#222",fontSize:14,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:"1 1 0%",minWidth:0,maxWidth:"calc(100% - 40px)",mr:0},children:((I=x.persona)==null?void 0:I.name)||"Unknown Persona"}),e.jsx(H,{size:"small",onClick:k=>Ue(k,x.id),sx:{color:"#666",flexShrink:0,p:"4px",ml:.5,"&:hover":{color:"#1976d2",backgroundColor:"rgba(25, 118, 210, 0.08)"}},children:e.jsx(Ts,{sx:{fontSize:16}})})]}),e.jsx(p,{sx:{color:"#666",fontSize:12,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:0},children:x.lastMessage||"No messages"})]})]},x.id)}):e.jsx(F,{sx:{px:0,py:{xs:1,sm:1.2},minWidth:0},children:e.jsx(K,{primary:e.jsx(p,{sx:{fontWeight:500,color:"#888",fontSize:{xs:14,sm:15},fontStyle:"italic"},children:z?`No ${z} chats yet`:"No recent chats"})})})}),e.jsxs(ts,{anchorEl:W,open:!!W,onClose:B,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsxs(Ze,{onClick:()=>{$&&$e($,{}),B()},children:[e.jsx(Os,{sx:{mr:1}})," Share"]}),e.jsxs(Ze,{onClick:()=>{$&&He($)},children:[e.jsx(ps,{sx:{mr:1}})," Conversation Settings"]})]}),e.jsxs(Ke,{open:ae,onClose:()=>q(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(gt,{children:"Share Conversation"}),e.jsxs(vt,{children:[e.jsx(p,{sx:{mb:1},children:"Shareable link (copied to clipboard):"}),e.jsx(It,{fullWidth:!0,value:Fe,InputProps:{readOnly:!0}})]}),e.jsxs(bt,{children:[e.jsx(V,{onClick:async()=>{try{await navigator.clipboard.writeText(Fe)}catch{}},variant:"outlined",children:"Copy"}),e.jsx(V,{onClick:()=>q(!1),variant:"contained",children:"Close"})]})]}),e.jsx(wt,{open:O,onClose:Pe,conversation:ie,onConversationUpdate:te})]})},Us=(r,o)=>{if(!o)return r;const c=new RegExp(`(${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return r.split(c).map((g,b)=>c.test(g)?e.jsx("span",{style:{background:"#ffe082"},children:g},b):e.jsx(_e.Fragment,{children:g},b))},Hs=({open:r,onClose:o,sessions:c,onSelect:g,onStartNewChat:b,hasPersonaContext:t=!0})=>{const[S,L]=n.useState(""),[D,u]=n.useState([]),[A,R]=n.useState(0),M=n.useRef(null);n.useEffect(()=>{r&&(L(""),u([]),R(t?0:1),setTimeout(()=>{var f;return(f=M.current)==null?void 0:f.focus()},100))},[r,t]),n.useEffect(()=>{if(!S.trim()){u([]),R(t?0:1);return}const f=S.toLowerCase(),v=[],w=new Set;c.forEach(z=>{(z.messages||[]).forEach((W,C)=>{if(typeof W.user_message=="string"||typeof W.ai_response=="string"){if(typeof W.user_message=="string"&&W.user_message.toLowerCase().includes(f)){const O=`${z.session_id}-${C}-user`;w.has(O)||(w.add(O),v.push({session_id:z.session_id,msgIdx:C,message:{text:W.user_message,sender:"user"},date:z.date}))}if(typeof W.ai_response=="string"&&W.ai_response.toLowerCase().includes(f)){const O=`${z.session_id}-${C}-ai`;w.has(O)||(w.add(O),v.push({session_id:z.session_id,msgIdx:C,message:{text:W.ai_response,sender:"ai"},date:z.date}))}return}const $=typeof W.text=="string"?W.text:"",G=W.sender==="user"||W.sender==="ai"?W.sender:void 0;if($&&$.toLowerCase().includes(f)){const O=`${z.session_id}-${C}-${G||"unknown"}`;w.has(O)||(w.add(O),v.push({session_id:z.session_id,msgIdx:C,message:{text:$,sender:G||"user"},date:z.date}))}})}),u(v),R(t?0:1)},[S,c,t]);const _=f=>{f.key==="ArrowDown"?(R(v=>{const w=t?D.length:D.length-1;return Math.min(v+1,w)}),f.preventDefault()):f.key==="ArrowUp"?(R(v=>Math.max(v-1,t?0:1)),f.preventDefault()):f.key==="Enter"?A===0&&t?(b(),o()):D[A-(t?1:0)]&&(g(D[A-(t?1:0)]),o()):f.key==="Escape"&&o()};return e.jsx(ss,{open:r,onClose:o,children:e.jsx(i,{sx:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300},children:e.jsx(St,{onClickAway:o,children:e.jsxs(gs,{sx:{width:{xs:"90vw",sm:500},maxHeight:500,p:2,outline:"none",borderRadius:3,boxShadow:6,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:600,color:"#374151"},children:"Search Chats"}),e.jsx(p,{variant:"caption",sx:{color:"#6B7280",fontFamily:"monospace"},children:"âŒ˜K"})]}),e.jsx(us,{inputRef:M,value:S,onChange:f=>L(f.target.value),onKeyDown:_,placeholder:t?"Search all chats...":"Search chats (navigate to a persona first)",disabled:!t,sx:{fontSize:18,px:1,py:.5,border:"1px solid #e0e0e0",borderRadius:2,mb:1,bgcolor:t?"#fafafa":"#f5f5f5",opacity:t?1:.7,cursor:t?"text":"not-allowed"},fullWidth:!0,autoFocus:t}),!t&&e.jsxs(i,{sx:{p:2,mb:1,bgcolor:"#FEF3C7",border:"1px solid #F59E0B",borderRadius:2,textAlign:"center"},children:[e.jsx(p,{variant:"body2",color:"#92400E",sx:{fontWeight:500},children:"ðŸ” Search Unavailable"}),e.jsx(p,{variant:"caption",color:"#92400E",sx:{display:"block",mt:.5},children:"Navigate to a persona chat page to search through conversations"})]}),e.jsxs(ce,{sx:{maxHeight:320,overflowY:"auto",p:0},children:[e.jsxs(F,{selected:A===0,onClick:()=>{t&&(b(),o())},disabled:!t,sx:{bgcolor:A===0?"#E8ECF2":void 0,borderRadius:2,mb:.5,cursor:t?"pointer":"not-allowed",alignItems:"center",fontWeight:600,color:t?"#2950DA":"#9CA3AF",opacity:t?1:.6},children:["+ Start a new chat",!t&&e.jsx(p,{variant:"caption",sx:{ml:1,color:"#6B7280",fontStyle:"italic"},children:"(No persona context)"})]}),e.jsx(mt,{sx:{my:1}}),!t&&e.jsx(F,{sx:{px:2,py:1},children:e.jsx(p,{variant:"body2",color:"text.secondary",sx:{fontStyle:"italic",textAlign:"center",width:"100%"},children:"Navigate to a persona chat to start new conversations"})}),D.length===0&&S.trim()&&e.jsx(F,{children:e.jsx(p,{color:"text.secondary",children:"No results found."})}),D.map((f,v)=>e.jsx(F,{selected:A===v+1,onClick:()=>{g(f),o()},sx:{bgcolor:A===v+1?"#e0f7fa":void 0,borderRadius:2,mb:.5,cursor:"pointer",alignItems:"flex-start"},children:e.jsxs(i,{sx:{flex:1},children:[e.jsxs(p,{variant:"caption",color:"text.secondary",children:["Session: ",f.session_id," ",f.date?`| ${new Date(f.date).toLocaleString()}`:""]}),e.jsx(p,{variant:"body2",sx:{fontWeight:500,color:f.message.sender==="user"?"#2950DA":"#526794"},children:f.message.sender==="user"?"You":"AI"}),e.jsx(p,{variant:"body1",children:Us(f.message.text,S)})]})},f.session_id+"-"+f.msgIdx))]})]})})})})};var ye={},ct;function Ps(){if(ct)return ye;ct=1;var r=X();Object.defineProperty(ye,"__esModule",{value:!0}),ye.default=void 0;var o=r(Z()),c=Q();return ye.default=(0,o.default)((0,c.jsx)("path",{d:"M1 21h4V9H1zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73z"}),"ThumbUp"),ye}var qs=Ps();const Bs=J(qs);var je={},dt;function Ns(){if(dt)return je;dt=1;var r=X();Object.defineProperty(je,"__esModule",{value:!0}),je.default=void 0;var o=r(Z()),c=Q();return je.default=(0,o.default)((0,c.jsx)("path",{d:"M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2m4 0v12h4V3z"}),"ThumbDown"),je}var Ks=Ns();const Vs=J(Ks),Gs=({messageId:r,reactions:o=[],currentUserId:c,onReactionUpdate:g,disabled:b=!1})=>{const[t,S]=n.useState(!1),[L,D]=n.useState(null),u=o.find(f=>f.userId===c),A=o.filter(f=>f.type==="LIKE").length,R=o.filter(f=>f.type==="DISLIKE").length,M=async f=>{if(!(b||t)){S(!0),D(null);try{const v=await is(r,f);g&&g(r,v.data)}catch(v){const w=v instanceof Error?v.message:"Failed to update reaction";D(w)}finally{S(!1)}}},_=()=>{D(null)};return e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5,mt:1},children:[e.jsx(rt,{title:`${A} like${A!==1?"s":""}`,children:e.jsx(H,{size:"small",onClick:()=>M("LIKE"),disabled:b||t,sx:{color:(u==null?void 0:u.type)==="LIKE"?"#1976d2":"#666",bgcolor:(u==null?void 0:u.type)==="LIKE"?"rgba(25, 118, 210, 0.1)":"transparent","&:hover":{bgcolor:(u==null?void 0:u.type)==="LIKE"?"rgba(25, 118, 210, 0.2)":"rgba(0, 0, 0, 0.04)"}},children:t?e.jsx(Ie,{size:16}):e.jsx(Bs,{fontSize:"small"})})}),e.jsx(rt,{title:`${R} dislike${R!==1?"s":""}`,children:e.jsx(H,{size:"small",onClick:()=>M("DISLIKE"),disabled:b||t,sx:{color:(u==null?void 0:u.type)==="DISLIKE"?"#d32f2f":"#666",bgcolor:(u==null?void 0:u.type)==="DISLIKE"?"rgba(211, 47, 47, 0.1)":"transparent","&:hover":{bgcolor:(u==null?void 0:u.type)==="DISLIKE"?"rgba(211, 47, 47, 0.2)":"rgba(0, 0, 0, 0.04)"}},children:t?e.jsx(Ie,{size:16}):e.jsx(Vs,{fontSize:"small"})})})]}),e.jsx(cs,{open:!!L,autoHideDuration:6e3,onClose:_,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(kt,{onClose:_,severity:"error",sx:{width:"100%"},children:L})})]})};var we={},xt;function Ys(){if(xt)return we;xt=1;var r=X();Object.defineProperty(we,"__esModule",{value:!0}),we.default=void 0;var o=r(Z()),c=Q();return we.default=(0,o.default)((0,c.jsx)("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"}),"ContentCopy"),we}var Xs=Ys();const Qs=J(Xs);var Se={},ht;function Js(){if(ht)return Se;ht=1;var r=X();Object.defineProperty(Se,"__esModule",{value:!0}),Se.default=void 0;var o=r(Z()),c=Q();return Se.default=(0,o.default)((0,c.jsx)("path",{d:"M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6m6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26"}),"Autorenew"),Se}var Zs=Js();const er=J(Zs),tr=()=>e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5,py:1},children:[e.jsx(i,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:"#2950DA",animation:"typing 1.4s infinite ease-in-out",animationDelay:"0s","@keyframes typing":{"0%, 80%, 100%":{opacity:.3,transform:"scale(0.8)"},"40%":{opacity:1,transform:"scale(1)"}}}}),e.jsx(i,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:"#2950DA",animation:"typing 1.4s infinite ease-in-out",animationDelay:"0.2s","@keyframes typing":{"0%, 80%, 100%":{opacity:.3,transform:"scale(0.8)"},"40%":{opacity:1,transform:"scale(1)"}}}}),e.jsx(i,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:"#2950DA",animation:"typing 1.4s infinite ease-in-out",animationDelay:"0.4s","@keyframes typing":{"0%, 80%, 100%":{opacity:.3,transform:"scale(0.8)"},"40%":{opacity:1,transform:"scale(1)"}}}})]});function Ur(){var Qe;const{id:r}=Pt(),o=Ne(),[c]=qt(),g=c.get("conversationId"),b=c.get("draft"),[t,S]=n.useState(null),L=pt(),D=ut(L.breakpoints.down("sm")),[u,A]=n.useState(!1),[R,M]=n.useState(!1),[_,f]=n.useState(null),[v,w]=n.useState([]),[z,W]=n.useState(""),[C,$]=n.useState(""),[G,O]=n.useState(null),[ee,ie]=n.useState(""),[ne,ae]=n.useState(!1),q=n.useRef(null),[Fe,ke]=n.useState(""),[T,le]=n.useState(null),[Oe,$e]=n.useState(!1),[Ue,B]=n.useState(!0),[He,te]=n.useState(!1),[Pe,xe]=n.useState([]),[U,he]=n.useState(null),[Y,se]=n.useState(!1),[x,m]=n.useState(""),[I,k]=n.useState(""),{user:h}=xs(),P=n.useCallback(async()=>{try{const s=await vs();m(s.name)}catch(s){console.error("Error loading workspace details:",s);const a=Bt.getWorkspaceName();a&&m(a)}},[]),fe=n.useCallback(async()=>{try{const a=(await jt()||[]).map(l=>{var d,y,j;return{session_id:((d=l.conversation)==null?void 0:d.id)||l.sessionId,date:((y=l.conversation)==null?void 0:y.updatedAt)||((j=l.conversation)==null?void 0:j.createdAt),messages:(l.messages||[]).map(E=>({sender:E.role==="USER"?"user":"ai",text:E.content}))}}).filter(l=>l.session_id);xe(a)}catch{try{const d=((await tt()).data||[]).map(y=>({session_id:y.id,date:y.updatedAt,messages:(y.messages||[]).map(j=>({sender:j.role==="USER"?"user":"ai",text:j.content}))}));xe(d)}catch{}}},[]),[re,pe]=n.useState([]),N=n.useCallback(async()=>{if(t!=null&&t.id&&!b){g&&(se(!0),setTimeout(()=>{se(!1)},1e4));try{const s=await tt(),a=s.data.filter(l=>l.personaId===t.id);if(console.log("Current persona ID:",t==null?void 0:t.id),console.log("All conversations:",s.data.map(l=>{var d;return{id:l.id,personaId:l.personaId,persona:l.persona,personaName:(d=l.persona)==null?void 0:d.name}})),console.log("Persona conversations:",a.map(l=>{var d;return{id:l.id,personaId:l.personaId,persona:l.persona,personaName:(d=l.persona)==null?void 0:d.name}})),g){if(/^[a-z0-9]{25}$/.test(g))try{const y=(await ns(g)).data;if(y.personaId===t.id){$(g),le(y),Ce(y);return}else{console.log("Found conversation in all conversations, but it belongs to persona:",y.personaId);try{const j=await st(y.personaId);S(j);return}catch(j){console.error("Error loading correct persona:",j)}}}catch(d){console.error("Error loading specific conversation:",d)}}else if(C){const l=a.find(d=>d.id===C);l&&le(l)}}catch(s){console.error("Error loading conversations:",s)}finally{se(!1)}}},[t==null?void 0:t.id,g,C,c]);n.useEffect(()=>{if(b){$(""),le(null),w([]),se(!1);const s=new URL(window.location.href);s.searchParams.has("conversationId")&&(s.searchParams.delete("conversationId"),window.history.replaceState({},"",s.toString()))}},[b]),n.useEffect(()=>{t!=null&&t.id&&N()},[t==null?void 0:t.id,N]);const Ce=s=>{if(!s.messages||!Array.isArray(s.messages)){console.warn("No messages found in conversation:",s.id),w([]);return}const a=s.messages.map(l=>({sender:l.role==="USER"?"user":"ai",text:l.content,id:l.id,userId:l.userId,edited:l.edited||!1,reactions:l.reactions||[]}));w(a)};n.useEffect(()=>{async function s(){try{const a=await yt();pe(a.data||[])}catch(a){console.error("Error fetching personas from backend:",a),pe([])}}re.length===0&&s()},[re.length]),n.useEffect(()=>{P()},[P]),n.useEffect(()=>{try{const s=JSON.parse(localStorage.getItem("user")||"{}");ke(s.avatar||"")}catch{}},[]),n.useEffect(()=>{async function s(){if(r)try{B(!0);const a=await st(r);S(a)}catch(a){console.error("Error fetching persona from backend:",a)}finally{B(!1)}else B(!1)}r&&(!t||t.id!==r)?s():r||B(!1)},[r,t==null?void 0:t.id]);const Ae=(s,a)=>{if(a==="1")return["Analyze payment gateway performance","Review transaction failure rates","Optimize checkout conversion rates","Check payment processing costs","Evaluate fraud detection metrics"];if(a==="2")return["Review product roadmap priorities","Analyze feature adoption metrics","Get user feedback insights","Check sprint progress status","Evaluate market competitive analysis"];switch(s){case"Tech":return["Ask about QR transaction flows","Get merchant risk metrics","Clarify settlement SLA"];case"Marketing":return["Request latest campaign stats","Ask for competitor analysis","Get social media insights"];case"Sales":return["Ask for sales pipeline update","Request lead conversion rates","Get monthly sales summary"];default:return["Ask a question","Request a report","Get latest updates"]}},We=_e.useMemo(()=>t?Ae(t.department||"",t.id):[],[t]);n.useEffect(()=>{const s=()=>{q.current&&q.current.scrollTo({top:q.current.scrollHeight,behavior:"smooth"})},a=setTimeout(()=>{requestAnimationFrame(s)},100);return()=>clearTimeout(a)},[v]),n.useEffect(()=>{const s=a=>{(a.ctrlKey||a.metaKey)&&a.key.toLowerCase()==="k"&&(a.preventDefault(),t!=null&&t.id&&(te(!0),fe()))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[fe,t==null?void 0:t.id]);const Ee=(s,a)=>{const l=v.find(d=>d.id===s);l&&l.sender==="user"&&(h!=null&&h.id&&l.userId&&l.userId!==h.id||(k(""),O(s),ie(a)))},De=async s=>{if(!ee.trim())return;if(!/^[a-z0-9]{25}$/.test(s)){k("Cannot edit: invalid message id");return}const l=v.find(d=>d.id===s);if(!l||l.sender!=="user"){k("Only your own messages can be edited");return}if(h!=null&&h.id&&l.userId&&l.userId!==h.id){k("Only your own messages can be edited");return}try{ae(!0),k("");const d=await as(s,ee.trim());if(w(y=>y.map(j=>j.id===s?{...j,text:ee.trim(),edited:!0}:j)),d.data.assistantMessageId){const y=d.data.assistantMessageContent??"";w(j=>[...j,{sender:"ai",text:y,id:d.data.assistantMessageId,edited:!1,reactions:[]}])}if(d.data.conversationId&&d.data.conversationId!==C){$(d.data.conversationId);const y=new URL(window.location.href);y.searchParams.set("conversationId",d.data.conversationId),window.history.replaceState({},"",y.toString())}await N(),O(null),ie("")}catch(d){const y=(d==null?void 0:d.message)||"Failed to edit message";k(y),console.error("Error editing message:",d)}finally{ae(!1)}},Re=()=>{O(null),ie("")},ze=(s,a)=>{w(l=>l.map(d=>{if(d.id===s){let j=[...d.reactions||[]];return a.action==="added"?j.push({id:Date.now().toString(),type:a.type,userId:"current-user",createdAt:new Date().toISOString()}):a.action==="removed"?j=j.filter(E=>!(E.type===a.type&&E.userId==="current-user")):a.action==="updated"&&(j=j.map(E=>E.userId==="current-user"?{...E,type:a.type}:E)),{...d,reactions:j}}return d}))},Le=()=>{$e(!1)},Ct=(s,a)=>{if(T&&T.id===s&&le({...T,...a}),a.archivedAt!==void 0&&a.archivedAt!==null){o(`/personas/${t==null?void 0:t.id}`);return}N()},Ve=Ue;if(!t)return e.jsxs(i,{sx:{height:"100vh",bgcolor:"#fff",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[e.jsx(Je,{open:Ve,sx:{color:"#fff",zIndex:s=>s.zIndex.modal+1},children:e.jsx(Ie,{color:"inherit"})}),e.jsx(p,{variant:"h6",sx:{color:"#2950DA"},children:"Persona not found"})]});const At=()=>A(!0),Ge=()=>A(!1),Ye=280,Wt=()=>{o("/discovery")},qe=()=>{M(!1),f(null)},Et=s=>{M(!1),B(!0),o(`/chat/${s}`)},Dt=()=>{o(`/view-persona/${t.id}`)},Rt=async s=>{const a=(s.message||"").trim();if(!(!a||!t)){ae(!0);try{const l=Date.now().toString();w(E=>[...E,{sender:"user",text:a,id:l,userId:h==null?void 0:h.id}]),W(""),w(E=>[...E,{sender:"ai",text:"",isTyping:!0}]);const d=/^[a-z0-9]{25}$/,y=C&&d.test(C)?C:g&&d.test(g)?g:void 0;console.log("Using conversation ID:",y);const j=await ls(t.id,a,y,s.fileId);if(!C&&j.data.conversationId){$(j.data.conversationId);const E=new URL(window.location.href);E.searchParams.set("conversationId",j.data.conversationId),window.history.replaceState({},"",E.toString())}w(E=>E.map(oe=>oe.id===l?{...oe,id:j.data.messageId}:oe)),w(E=>{const oe=[...E];return oe[oe.length-1]={sender:"ai",text:j.data.reply,id:j.data.messageId,isTyping:!1},oe}),await N()}catch(l){console.error("Error sending message:",l),w(d=>{const y=[...d];return y[y.length-1]={sender:"ai",text:"Sorry, there was an error sending your message. Please try again.",isTyping:!1},y})}finally{ae(!1)}}},zt=v.filter(s=>s.sender==="user").length>0,Xe=g&&(Y||v.length===0);return e.jsxs(i,{sx:{height:"100vh",bgcolor:"#fff",display:"flex",flexDirection:"column",overflow:"hidden",width:"100vw",maxWidth:"100vw",fontFamily:"Inter, Roboto, Helvetica, Arial, sans-serif"},children:[e.jsx(Je,{open:Ve,sx:{color:"#fff",zIndex:s=>s.zIndex.modal+2},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(Ie,{color:"inherit"}),e.jsx(p,{sx:{fontWeight:600},children:"Loading chat..."})]})}),e.jsx(Ms,{onBack:Wt,onMenu:At,isSidebarOpen:u,backIcon:e.jsx(ks,{sx:{fontSize:{xs:24,sm:28},color:"#012A1F"}})}),e.jsxs(i,{sx:{display:"flex",flexDirection:"row",flex:1,overflow:"hidden",width:"100%",maxWidth:"100vw",position:"relative"},children:[u&&D&&e.jsx(i,{sx:{position:"fixed",top:0,left:0,right:0,bottom:0,bgcolor:"rgba(0, 0, 0, 0.5)",zIndex:1199,transition:"opacity 0.3s ease"},onClick:Ge}),e.jsx(i,{sx:{position:"fixed",top:0,left:0,height:"100vh",zIndex:1200,transform:u?"translateX(0)":"translateX(-100%)",transition:"transform 0.3s cubic-bezier(.4,0,.2,1)"},children:e.jsx($s,{onClose:Ge,currentPersonaId:t.id,currentConversationId:C,activePersona:{id:t.id,name:t.personalName||t.name,avatarUrl:t.avatarUrl||t.avatar},activeLastMessage:v.length>0&&((Qe=v[v.length-1])==null?void 0:Qe.text)||"",onSearchChats:()=>te(!0)})}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",position:"relative",transition:"margin-left 0.3s cubic-bezier(.4,0,.2,1)",ml:{xs:0,md:u?`${Ye}px`:0},height:"100%",width:"100%",maxWidth:"100vw",overflow:"hidden"},children:[e.jsxs(i,{ref:q,sx:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",width:"100%",maxWidth:"100vw",mx:0,overflowY:"auto",overflowX:"hidden",pb:{xs:16,sm:24,md:28},scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"},minHeight:0},children:[e.jsxs(i,{sx:{width:"100%",maxWidth:{xs:"100%",sm:720,md:900},mx:"auto",mb:2,display:"flex",flexDirection:"column",gap:{xs:1.5,sm:2},px:{xs:1.5,sm:2,md:0},overflow:"visible"},children:[!Xe&&e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",mb:{xs:2,sm:3},px:{xs:2,sm:0},pt:{xs:2,sm:3},pb:{xs:1,sm:2},position:"relative"},children:[e.jsx(de,{src:t.avatarUrl||t.avatar||"",sx:{width:{xs:80,sm:96},height:{xs:80,sm:96},mb:{xs:1.5,sm:2},cursor:"pointer",transition:"transform 0.2s ease-in-out","&:hover":{transform:"scale(1.05)"}},onClick:Dt,onError:s=>{console.error("Avatar image failed to load:",t.avatarUrl||t.avatar),console.error("Error event:",s)},onLoad:()=>{}},t.id),e.jsxs(p,{variant:"h5",sx:{fontWeight:600,color:"#222",mb:.5,fontSize:{xs:"20px",sm:"24px"},textAlign:"center"},children:[t.personalName||t.name,t.isAvailable===!1&&e.jsx(i,{component:"span",sx:{ml:1,px:1,py:.5,bgcolor:"#ffebee",color:"#c62828",fontSize:"12px",borderRadius:1,fontWeight:500},children:"Temporarily Unavailable"})]}),e.jsx(p,{variant:"subtitle1",sx:{color:"#2950DA",fontWeight:400,fontSize:{xs:16,sm:18},textAlign:"center"},children:t.name}),t.department&&e.jsx(p,{variant:"body2",sx:{color:"#666",fontWeight:400,fontSize:{xs:14,sm:16},textAlign:"center",mt:.5},children:t.department}),t.description&&e.jsx(p,{variant:"body2",sx:{color:"#888",fontWeight:400,fontSize:{xs:13,sm:15},textAlign:"center",mt:.5},children:t.description}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(er,{onClick:()=>M(!0),sx:{ml:1,color:"#2950DA",fontSize:32,cursor:"pointer",borderRadius:"50%",transition:"background 0.2s","&:hover":{background:"#E8ECF2"}}})}),e.jsxs(Ke,{open:R,onClose:qe,maxWidth:"xs",fullWidth:!0,children:[e.jsx(gt,{sx:{fontWeight:600,fontSize:22,color:"#222",textAlign:"center"},children:"Switch Persona"}),e.jsxs(vt,{sx:{p:3},children:[re.filter(s=>s.id!==t.id).map(s=>e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2,cursor:"pointer",borderRadius:2,p:1.2,"&:hover":{background:"#f5f5f5"}},onClick:()=>Et(s.id),children:[e.jsx(de,{src:s.avatarUrl||s.avatar||"",sx:{width:48,height:48}},s.id),e.jsxs(i,{children:[e.jsxs(p,{sx:{fontWeight:600,fontSize:18,color:"#222"},children:[s.name,s.isAvailable===!1&&e.jsx(i,{component:"span",sx:{ml:1,px:1,py:.5,bgcolor:"#ffebee",color:"#c62828",fontSize:"10px",borderRadius:1,fontWeight:500},children:"Unavailable"})]}),e.jsx(p,{sx:{color:"#2950DA",fontSize:16},children:s.role})]})]},s.id)),re.filter(s=>s.id!==t.id).length===0&&e.jsx(p,{sx:{color:"#888",textAlign:"center",mt:2},children:"No other personas available."})]}),e.jsx(bt,{sx:{justifyContent:"center",pb:2},children:e.jsx(V,{onClick:qe,variant:"outlined",color:"primary",children:"Cancel"})})]})]}),Y&&e.jsxs(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4,color:"#666"},children:[e.jsx(Ie,{size:24,sx:{mr:2}}),e.jsx(p,{variant:"body2",children:"Restoring conversation..."})]}),!Y&&g&&!b&&v.length===0&&e.jsxs(i,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",py:4,color:"#666",textAlign:"center"},children:[e.jsx(p,{variant:"body1",sx:{mb:2},children:"Failed to restore conversation"}),e.jsx(V,{variant:"outlined",onClick:()=>N(),sx:{color:"#2950DA",borderColor:"#2950DA"},children:"Retry"})]}),!Y&&v.map((s,a)=>s.sender==="ai"?e.jsx(i,{"data-msg-idx":a,sx:{width:"100%",display:"flex",justifyContent:"flex-start",mb:2},children:e.jsx(i,{sx:{display:"flex",flexDirection:"row",alignItems:"flex-start",gap:2,maxWidth:"100%"},children:e.jsxs(i,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[e.jsx(i,{sx:{color:"#2950DA",fontWeight:500,fontSize:16,mb:1},children:t.name}),s.isTyping?e.jsx(i,{sx:{bgcolor:"#EEF3FF",color:"#1E3A8A",px:{xs:2.5,sm:2},py:{xs:2,sm:2.5},borderRadius:3,fontSize:16,fontWeight:400,maxWidth:{xs:"100%",sm:600},wordBreak:"break-word",boxShadow:"none",lineHeight:1.5,textAlign:"left",whiteSpace:"pre-wrap"},children:e.jsx(tr,{})}):e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1,maxWidth:{xs:"100%",sm:600}},children:[s.fileUrl&&e.jsx(i,{sx:{bgcolor:"#EEF3FF",borderRadius:3,p:1,boxShadow:"none"},children:s.fileType&&s.fileType.startsWith("image/")?e.jsx("img",{src:s.fileUrl,alt:"attachment",style:{maxWidth:250,maxHeight:250,borderRadius:8,display:"block",width:"100%",height:"auto"}}):e.jsx(i,{sx:{width:20,height:20,bgcolor:"#1E3A8A",borderRadius:1,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:()=>window.open(s.fileUrl,"_blank"),children:e.jsx(i,{sx:{width:12,height:12,bgcolor:"#fff",borderRadius:.5}})})}),s.text&&e.jsxs(e.Fragment,{children:[e.jsx(i,{sx:{bgcolor:"#EEF3FF",color:"#1E3A8A",px:{xs:2.5,sm:2},py:{xs:2,sm:2.5},borderRadius:3,fontSize:16,fontWeight:400,wordBreak:"break-word",boxShadow:"none",lineHeight:1.5,textAlign:"left",whiteSpace:"pre-wrap",maxWidth:"100%"},children:s.text.match(/(\n\s*[-*]|^\d+\.|^#)/m)?e.jsx(fs,{content:s.text}):s.text}),e.jsx(H,{size:"small","aria-label":"Copy AI response",sx:{mt:.5,alignSelf:"flex-start",color:"#1E3A8A"},onClick:()=>{s.text&&(navigator.clipboard.writeText(s.text),he(s.id||`msg-${a}`),setTimeout(()=>{he(null)},2e3))},children:U===(s.id||`msg-${a}`)?e.jsx(nt,{fontSize:"small",sx:{color:"#10B981"}}):e.jsx(Qs,{fontSize:"small"})})]}),s.id&&e.jsx(Gs,{messageId:s.id,reactions:s.reactions,currentUserId:"current-user",onReactionUpdate:ze,disabled:ne||!!(T!=null&&T.archivedAt)})]})]})})},a):e.jsx(i,{"data-msg-idx":a,sx:{width:"100%",display:"flex",justifyContent:"flex-end",mb:2,mr:{xs:0,sm:4}},children:e.jsx(i,{sx:{display:"flex",flexDirection:"row-reverse",alignItems:"flex-end",gap:1,maxWidth:"100%"},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:1,maxWidth:{xs:"100%",sm:400}},children:[s.fileUrls&&s.fileUrls.length>0&&e.jsx(i,{sx:{display:"flex",gap:1,flexWrap:"wrap",mb:1},children:s.fileUrls.map((l,d)=>e.jsx("img",{src:l,alt:`attachment-${d}`,style:{width:"3rem",height:"3rem",display:"block"}},d))}),s.fileUrl&&!s.fileUrls&&(s.fileType&&s.fileType.startsWith("image/")?e.jsx("img",{src:s.fileUrl,alt:"attachment",style:{width:"3rem",height:"3rem",display:"block"}}):e.jsx(i,{sx:{width:20,height:20,bgcolor:"#fff",borderRadius:1,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:()=>window.open(s.fileUrl,"_blank"),children:e.jsx(i,{sx:{width:12,height:12,bgcolor:"#2950DA",borderRadius:.5}})})),s.text&&e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1,position:"relative","&:hover .edit-button":{opacity:1}},children:[e.jsx(i,{sx:{bgcolor:"#2950DA",color:"#fff",px:{xs:2.5,sm:3},py:{xs:2,sm:2.5},borderRadius:3,fontSize:16,fontWeight:400,wordBreak:"break-word",boxShadow:"0 2px 8px rgba(44,62,80,0.04)",lineHeight:1.5,textAlign:"start",whiteSpace:"pre-wrap",maxWidth:"100%"},children:G===s.id?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsx(It,{value:ee,onChange:l=>ie(l.target.value),multiline:!0,fullWidth:!0,variant:"outlined",error:!!I,helperText:I||"",sx:{"& .MuiOutlinedInput-root":{color:"#fff","& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"rgba(255,255,255,0.5)"},"&.Mui-focused fieldset":{borderColor:"#fff"}}}}),e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[e.jsx(H,{size:"small",onClick:()=>De(s.id),disabled:ne,sx:{color:"#fff",bgcolor:"rgba(255,255,255,0.1)"},children:e.jsx(nt,{fontSize:"small"})}),e.jsx(H,{size:"small",onClick:Re,sx:{color:"#fff",bgcolor:"rgba(255,255,255,0.1)"},children:e.jsx(Kt,{fontSize:"small"})})]})]}):e.jsxs(i,{children:[s.text,s.edited&&e.jsx(p,{variant:"caption",sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.75rem",ml:1},children:"(edited)"})]})}),G!==s.id&&s.sender==="user"&&e.jsx(H,{className:"edit-button",size:"small",onClick:()=>Ee(s.id,s.text),sx:{position:"absolute",right:8,bottom:-32,color:"#666",bgcolor:"rgba(0,0,0,0.05)",opacity:0,transition:"opacity 0.2s",pointerEvents:"auto","&:hover":{bgcolor:"rgba(0,0,0,0.1)",opacity:1}},children:e.jsx(Nt,{fontSize:"small"})})]})]})})},a))]}),R&&_&&e.jsx(St,{onClickAway:qe,children:e.jsx(i,{sx:{position:"absolute",top:{xs:140,sm:160},left:{xs:"50%",sm:"calc(50% + 100px)"},transform:{xs:"translateX(-50%)",sm:"none"},bgcolor:"#F8F9FA",borderRadius:2,boxShadow:"0 2px 8px 0 rgba(44,62,80,0.10)",p:{xs:1,sm:1.1},minWidth:{xs:200,sm:160},zIndex:30},children:e.jsx(p,{variant:"h6",sx:{color:"#888",fontWeight:600,mb:1,fontSize:{xs:14,sm:15}},children:"Switch Persona"})})})]}),e.jsxs(i,{sx:{position:"absolute",left:0,right:0,bottom:0,display:"flex",flexDirection:"column",alignItems:"center",pt:0,pb:{xs:2,sm:4},background:"linear-gradient(180deg, rgba(255,255,255,0) 0%, #fff 20%)"},children:[(T==null?void 0:T.archivedAt)&&e.jsx(i,{sx:{mb:2,px:2,maxWidth:960,width:"100%"},children:e.jsx(kt,{severity:"info",sx:{borderRadius:2},children:e.jsxs(p,{variant:"body2",children:[e.jsx("strong",{children:"This conversation is archived."})," You cannot send new messages or edit existing ones. You can unarchive it from the conversation settings to continue chatting."]})})}),e.jsx(ms,{value:z,onChange:W,onSend:Rt,disabled:ne||!!(T!=null&&T.archivedAt)||Y,persona:t,conversationId:C,sidebarOpen:u,sidebarWidth:Ye,maxWidth:960,suggestions:We,showSuggestions:!zt&&!Xe})]})]})]}),e.jsx(wt,{open:Oe,onClose:Le,conversation:T,onConversationUpdate:Ct}),e.jsx(Hs,{open:He,onClose:()=>te(!1),sessions:Pe,onSelect:({session_id:s})=>{te(!1),t!=null&&t.id&&o(`/chat/${t.id}?conversationId=${s}`)},onStartNewChat:()=>{if(te(!1),t!=null&&t.id){const s=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;o(`/chat/${t.id}?draft=${s}`)}else o("/personas")},hasPersonaContext:!!(t!=null&&t.id)})]})}export{Ur as default};
